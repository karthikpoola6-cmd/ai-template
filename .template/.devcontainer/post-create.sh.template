#!/bin/bash
# Generated from template - do not edit directly
# Regenerate with: ./scripts/bootstrap/bootstrap.sh

set -e

# Colors for output
CYAN='\033[36m'
GREEN='\033[32m'
YELLOW='\033[33m'
RED='\033[31m'
RESET='\033[0m'

echo ""
echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
echo -e "${CYAN}â•‘                                                            â•‘${RESET}"
echo -e "${CYAN}â•‘     ðŸš€ Setting up {{PROJECT_NAME}} development environment${RESET}"
echo -e "${CYAN}â•‘                                                            â•‘${RESET}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""

cd /workspaces/{{PROJECT_NAME}} || exit 1

# ============================================================================
# Wait for Services
# ============================================================================

{{#IF_POSTGRES}}
echo -e "${CYAN}â³ Waiting for PostgreSQL...${RESET}"
for i in {1..30}; do
    if pg_isready -h db -p 5432 -U {{DB_USER}} > /dev/null 2>&1; then
        echo -e "${GREEN}âœ… PostgreSQL is ready${RESET}"
        break
    fi
    if [ $i -eq 30 ]; then
        echo -e "${YELLOW}âš ï¸  PostgreSQL not ready after 30 seconds${RESET}"
    fi
    sleep 1
done

{{/IF_POSTGRES}}
{{#IF_REDIS}}
echo -e "${CYAN}â³ Waiting for Redis...${RESET}"
for i in {1..30}; do
    if redis-cli -h redis -p 6379 ping > /dev/null 2>&1; then
        echo -e "${GREEN}âœ… Redis is ready${RESET}"
        break
    fi
    if [ $i -eq 30 ]; then
        echo -e "${YELLOW}âš ï¸  Redis not ready after 30 seconds${RESET}"
    fi
    sleep 1
done

{{/IF_REDIS}}
# ============================================================================
# Language-Specific Setup
# ============================================================================

{{#IF_GO}}
echo -e "${CYAN}ðŸ”§ Installing Go development tools...${RESET}"
go install github.com/air-verse/air@latest 2>/dev/null || true
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest 2>/dev/null || true
go install golang.org/x/tools/cmd/goimports@latest 2>/dev/null || true
go install github.com/go-delve/delve/cmd/dlv@latest 2>/dev/null || true
echo -e "${GREEN}âœ… Go tools installed${RESET}"

{{/IF_GO}}
{{#IF_PYTHON}}
echo -e "${CYAN}ðŸ Setting up Python environment...${RESET}"
pip install --upgrade pip --quiet

# Install common dev tools (versions synced with .template/config/versions.yaml)
pip install --quiet \
    "ruff>=0.8.0" \
    "mypy>=1.8.0" \
    "pytest>=8.0.0" \
    pytest-cov \
    pytest-asyncio \
    httpx \
    pyyaml

# Install project dependencies if pyproject.toml exists
if [ -f "pyproject.toml" ]; then
    echo -e "${CYAN}   Installing project dependencies...${RESET}"
    pip install -e ".[dev]" --quiet 2>/dev/null || pip install -e . --quiet 2>/dev/null || true
fi

# Install requirements.txt if it exists
if [ -f "requirements.txt" ]; then
    echo -e "${CYAN}   Installing requirements.txt...${RESET}"
    pip install -r requirements.txt --quiet
fi

if [ -f "requirements-dev.txt" ]; then
    echo -e "${CYAN}   Installing requirements-dev.txt...${RESET}"
    pip install -r requirements-dev.txt --quiet
fi

echo -e "${GREEN}âœ… Python environment ready${RESET}"

{{/IF_PYTHON}}
{{#IF_NODE}}
echo -e "${CYAN}ðŸ“¦ Setting up Node.js environment...${RESET}"

# Install global tools
npm install -g npm@latest --silent 2>/dev/null || true

# Install project dependencies if package.json exists
if [ -f "package.json" ]; then
    echo -e "${CYAN}   Installing npm dependencies...${RESET}"
    npm install --silent 2>/dev/null || true
fi

echo -e "${GREEN}âœ… Node.js environment ready${RESET}"

{{/IF_NODE}}
{{#IF_RUST}}
echo -e "${CYAN}ðŸ¦€ Setting up Rust environment...${RESET}"

# Update rust and install common tools
rustup update stable --quiet 2>/dev/null || true
rustup component add rustfmt clippy --quiet 2>/dev/null || true
cargo install cargo-watch --quiet 2>/dev/null || true

echo -e "${GREEN}âœ… Rust environment ready${RESET}"

{{/IF_RUST}}
# ============================================================================
# Additional Tools
# ============================================================================

{{#IF_GH_CLI}}
echo -e "${CYAN}ðŸ™ Installing GitHub CLI...${RESET}"
if ! command -v gh &> /dev/null; then
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg 2>/dev/null \
    && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && sudo apt update -qq \
    && sudo apt install gh -y -qq
    echo -e "${GREEN}âœ… GitHub CLI installed${RESET}"
else
    echo -e "${GREEN}âœ… GitHub CLI already installed${RESET}"
fi

{{/IF_GH_CLI}}
{{#IF_PULUMI}}
echo -e "${CYAN}â˜ï¸  Installing Pulumi...${RESET}"
if ! command -v pulumi &> /dev/null; then
    curl -fsSL https://get.pulumi.com | sh -s -- --no-edit-path 2>/dev/null
    echo 'export PATH="$PATH:$HOME/.pulumi/bin"' >> ~/.bashrc
    echo -e "${GREEN}âœ… Pulumi installed${RESET}"
else
    echo -e "${GREEN}âœ… Pulumi already installed${RESET}"
fi

{{/IF_PULUMI}}
{{#IF_GCLOUD}}
echo -e "${CYAN}â˜ï¸  Installing Google Cloud SDK...${RESET}"
if ! command -v gcloud &> /dev/null; then
    curl -fsSL https://sdk.cloud.google.com | bash -s -- --disable-prompts --install-dir=$HOME 2>/dev/null
    echo 'source ~/google-cloud-sdk/path.bash.inc' >> ~/.bashrc
    echo 'source ~/google-cloud-sdk/completion.bash.inc' >> ~/.bashrc
    export PATH="$PATH:$HOME/google-cloud-sdk/bin"
    echo -e "${GREEN}âœ… Google Cloud SDK installed${RESET}"
else
    echo -e "${GREEN}âœ… Google Cloud SDK already installed${RESET}"
fi

{{/IF_GCLOUD}}
{{#IF_CLAUDE_CODE}}
echo -e "${CYAN}ðŸ¤– Installing Claude Code CLI...${RESET}"
if ! command -v claude &> /dev/null; then
    curl -fsSL https://claude.ai/install.sh | bash 2>/dev/null || true
    echo -e "${GREEN}âœ… Claude Code CLI installed${RESET}"
else
    echo -e "${GREEN}âœ… Claude Code CLI already installed${RESET}"
fi

{{/IF_CLAUDE_CODE}}
{{#IF_INFISICAL}}
echo -e "${CYAN}ðŸ” Installing Infisical CLI...${RESET}"
if ! command -v infisical &> /dev/null; then
    curl -1sLf 'https://artifacts-cli.infisical.com/setup.deb.sh' | sudo -E bash 2>/dev/null
    sudo apt-get update -qq && sudo apt-get install -y -qq infisical
    echo -e "${GREEN}âœ… Infisical CLI installed${RESET}"
else
    echo -e "${GREEN}âœ… Infisical CLI already installed${RESET}"
fi

{{/IF_INFISICAL}}
{{#IF_PRECOMMIT}}
echo -e "${CYAN}ðŸª Setting up pre-commit hooks...${RESET}"
if command -v pre-commit &> /dev/null; then
    if [ -f ".pre-commit-config.yaml" ]; then
        pre-commit install --install-hooks 2>/dev/null || true
        echo -e "${GREEN}âœ… Pre-commit hooks installed${RESET}"
    fi
else
    pip install pre-commit --quiet
    if [ -f ".pre-commit-config.yaml" ]; then
        pre-commit install --install-hooks 2>/dev/null || true
        echo -e "${GREEN}âœ… Pre-commit hooks installed${RESET}"
    fi
fi

{{/IF_PRECOMMIT}}
# ============================================================================
# Git Configuration
# ============================================================================

echo -e "${CYAN}ðŸ”§ Configuring Git...${RESET}"

git config --global init.defaultBranch main
git config --global pull.rebase false
git config --global core.autocrlf input
git config --global --add safe.directory /workspaces/{{PROJECT_NAME}}

echo -e "${GREEN}âœ… Git configured${RESET}"

# ============================================================================
# Shell Aliases
# ============================================================================

if ! grep -q "# {{PROJECT_NAME}} aliases" ~/.bashrc 2>/dev/null; then
    cat >> ~/.bashrc << 'ALIASES'

# {{PROJECT_NAME}} aliases
alias ll='ls -alF'
alias la='ls -A'
alias ..='cd ..'
alias ...='cd ../..'
alias ws='cd /workspaces/{{PROJECT_NAME}}'
alias mh='make help'
alias mt='make test'
alias mq='make quality'
alias mc='make check'
ALIASES
fi

# ============================================================================
# Done!
# ============================================================================

echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
echo -e "${GREEN}â•‘     âœ¨ Development environment is ready!                  â•‘${RESET}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""
echo -e "${CYAN}ðŸŽ¯ Next steps:${RESET}"
echo ""
echo "   â€¢ Run ${CYAN}make doctor${RESET} to verify your setup"
echo "   â€¢ Run ${CYAN}make help${RESET} to see available commands"
{{#IF_AI_SESSIONS}}
echo "   â€¢ Run ${CYAN}make session-start${RESET} to begin an AI-assisted dev session"
{{/IF_AI_SESSIONS}}
echo "   â€¢ Run ${CYAN}make test${RESET} to run tests"
echo "   â€¢ Run ${CYAN}make quality${RESET} to check code quality"
echo ""
{{#IF_POSTGRES}}
echo -e "${CYAN}ðŸ“Š Database:${RESET} postgresql://{{DB_USER}}:{{DB_PASSWORD}}@db:5432/{{DB_NAME}}"
{{/IF_POSTGRES}}
{{#IF_REDIS}}
echo -e "${CYAN}ðŸ“¦ Redis:${RESET} redis://redis:6379"
{{/IF_REDIS}}
echo ""
echo -e "${GREEN}Happy coding! ðŸš€${RESET}"
echo ""
